# 实施计划: 仓库面板网格布局 Bug 修复

## 概述

本实施计划将修复仓库面板物品网格布局与分页逻辑不一致的问题。核心改动包括：
1. 添加动态列数计算逻辑
2. 将固定的 `itemsPerPage` 改为动态计算
3. 更新 CSS Grid 使用固定列数而不是 `auto-fill`
4. 添加响应式支持以处理容器大小变化
5. 添加防抖工具函数以优化性能

## 任务

- [x] 1. 添加工具函数和类型定义
  - 在 `src/ui/GameUI.ts` 中添加 `debounce` 工具函数
  - 更新 `GameUI` 类的属性定义，移除固定的 `itemsPerPage`，添加 `currentColumns`、`currentItemsPerPage` 和 `resizeObserver`
  - _需求: 7.1, 1.2_

- [x] 2. 实现列数计算逻辑
  - [x] 2.1 实现 `calculateGridColumns` 方法
    - 根据容器宽度、物品最小宽度（120px）和间距（12px）计算列数
    - 确保列数在 [1, 8] 范围内
    - _需求: 1.1, 3.1, 3.2, 3.3, 3.4_
  
  - [x] 2.2 为列数计算编写属性测试
    - **属性 1: 列数计算正确性**
    - **验证: 需求 1.1, 3.1, 3.2, 3.3, 3.4**

- [x] 3. 实现每页物品数量计算逻辑
  - [x] 3.1 实现 `calculateItemsPerPage` 方法
    - 基于列数和目标行数（3 行）计算每页物品数量
    - _需求: 1.2_
  
  - [x] 3.2 为每页物品数量计算编写属性测试
    - **属性 2: 每页物品数量计算**
    - **验证: 需求 1.2**

- [x] 4. 更新 `renderItemGrid` 方法
  - [x] 4.1 在渲染前获取容器宽度并计算列数
    - 使用 `getBoundingClientRect()` 获取容器宽度
    - 调用 `calculateGridColumns` 计算列数
    - 调用 `calculateItemsPerPage` 计算每页物品数量
    - 更新 `currentColumns` 和 `currentItemsPerPage` 属性
    - _需求: 1.1, 1.2, 1.3_
  
  - [x] 4.2 更新 CSS Grid 使用固定列数
    - 将 `grid-template-columns: repeat(auto-fill, minmax(120px, 1fr))` 改为 `grid-template-columns: repeat(${columns}, 1fr)`
    - _需求: 2.1_
  
  - [x] 4.3 使用动态计算的 `currentItemsPerPage` 进行分页
    - 更新 `paginateItems` 调用，使用 `this.currentItemsPerPage` 而不是固定的 `this.itemsPerPage`
    - 更新 `calculateTotalPages` 调用，使用 `this.currentItemsPerPage`
    - _需求: 1.3, 2.3_
  
  - [x] 4.4 为分页逻辑编写属性测试
    - **属性 3: 分页使用动态计算的容量**
    - **属性 5: 分页保持物品完整性**
    - **验证: 需求 1.3, 2.2, 2.3, 2.4**

- [x] 5. 实现响应式支持
  - [x] 5.1 实现 `setupResizeObserver` 方法
    - 创建 `ResizeObserver` 监听容器大小变化
    - 使用 `debounce` 包装回调函数（150ms 延迟）
    - 在列数改变时触发重新渲染
    - 处理 `ResizeObserver` 不支持的降级情况
    - _需求: 6.1, 6.2, 7.1, 7.3_
  
  - [x] 5.2 在 `renderItemGrid` 中调用 `setupResizeObserver`
    - 在渲染完成后设置观察器
    - 确保清理旧的观察器（如果存在）
    - _需求: 6.1_
  
  - [x] 5.3 为响应式逻辑编写属性测试
    - **属性 4: 列数改变触发容量更新**
    - **属性 9: 筛选状态保持**
    - **验证: 需求 1.4, 6.2, 6.3**

- [x] 6. 更新分页控件逻辑
  - [x] 6.1 实现页码自动调整逻辑
    - 在总页数改变时检查当前页码是否超出范围
    - 如果超出，自动调整到最后一页
    - _需求: 4.3, 6.4_
  
  - [x] 6.2 更新总页数计算
    - 确保使用 `currentItemsPerPage` 计算总页数
    - 确保总页数至少为 1
    - _需求: 4.1_
  
  - [x] 6.3 为分页控件编写属性测试
    - **属性 6: 总页数计算正确性**
    - **属性 7: 页码自动调整**
    - **验证: 需求 4.1, 4.3, 6.4**

- [x] 7. 更新筛选功能
  - [x] 7.1 确保筛选切换时重置页码并重新计算分页
    - 在筛选按钮点击处理器中，确保页码重置为 0
    - 确保使用筛选后的物品数量重新计算分页
    - _需求: 5.1, 5.2_
  
  - [x] 7.2 为筛选功能编写属性测试
    - **属性 8: 筛选重置分页**
    - **验证: 需求 5.1, 5.2**

- [x] 8. 添加错误处理
  - [x] 8.1 处理容器宽度异常情况
    - 容器宽度为 0 或负数时使用默认列数（4 列）
    - 记录警告日志
    - _需求: 3.4_
  
  - [x] 8.2 处理物品数组为空的情况
    - 确保空状态 UI 正确显示
    - 确保分页控件隐藏
    - _需求: 5.4_
  
  - [x] 8.3 为错误处理编写单元测试
    - 测试容器宽度为 0 的情况
    - 测试容器宽度为负数的情况
    - 测试物品数组为空的情况
    - 测试物品数组为 null 或 undefined 的情况

- [x] 9. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 确保没有回归问题
  - 如有问题请向用户询问

- [x] 10. 添加防抖函数测试
  - [x]* 10.1 为防抖函数编写属性测试
    - **属性 10: 防抖函数行为**
    - **验证: 需求 7.1**

- [x] 11. 添加条件渲染测试
  - [x]* 11.1 为条件渲染编写属性测试
    - **属性 11: 条件渲染**
    - **验证: 需求 7.3**

- [x] 12. 最终检查点 - 完整测试和验证
  - 运行所有测试确保通过
  - 手动测试不同容器宽度下的表现
  - 手动测试筛选和分页交互
  - 手动测试响应式行为（调整窗口大小）
  - 如有问题请向用户询问

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界条件
