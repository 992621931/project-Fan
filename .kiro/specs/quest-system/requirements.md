# éœ€æ±‚æ–‡æ¡£ï¼šä»»åŠ¡ç³»ç»Ÿï¼ˆQuest Systemï¼‰

## ç®€ä»‹

ä¸ºã€Œä»£å·ï¼šé¥­ã€æ‘åº„ç»è¥RPGæ¸¸æˆå®ç°ä¸€å¥—å®Œæ•´çš„ä»»åŠ¡ç³»ç»Ÿï¼ŒåŒ…å«ä¸»çº¿ä»»åŠ¡ã€æ”¯çº¿ä»»åŠ¡å’Œæ—¥å¸¸ä»»åŠ¡ä¸‰ç§ç±»å‹ã€‚ä»»åŠ¡ç³»ç»Ÿå°†å¼•å¯¼ç©å®¶é€æ­¥è§£é”NPCå’Œæ¸¸æˆåŠŸèƒ½ï¼Œæä¾›æŒç»­çš„æ¸¸æˆç›®æ ‡å’Œå¥–åŠ±æœºåˆ¶ã€‚ä»»åŠ¡é€šè¿‡è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿåˆ¤æ–­å®Œæˆæ¡ä»¶ï¼Œæ”¯æŒç‰©å“æŒæœ‰ã€åœºæ™¯è®¿é—®ã€åˆ¶ä½œå®Œæˆã€æˆ˜æ–—æ¢ç´¢ã€æ‹›å‹Ÿã€é€ç¤¼å’Œå¥½æ„Ÿåº¦ç­‰å¤šç§æ£€æµ‹ç±»å‹ã€‚

## æœ¯è¯­è¡¨

- **Quest_Systemï¼ˆä»»åŠ¡ç³»ç»Ÿï¼‰**: ç®¡ç†æ‰€æœ‰ä»»åŠ¡çš„åˆ›å»ºã€è¿½è¸ªã€æ£€æµ‹å’Œå®Œæˆçš„æ ¸å¿ƒç³»ç»Ÿ
- **Main_Questï¼ˆä¸»çº¿ä»»åŠ¡ï¼‰**: æ¸¸æˆå¼€å§‹å³å¯ç”¨çš„å¼•å¯¼æ€§ä»»åŠ¡é“¾ï¼Œé€æ­¥è§£é”NPCå’ŒåŠŸèƒ½
- **Side_Questï¼ˆæ”¯çº¿ä»»åŠ¡ï¼‰**: ä»NPCä»»åŠ¡æŒ‰é’®æ¥å–çš„ä¸­ç­‰éš¾åº¦ä¸€æ¬¡æ€§ä»»åŠ¡
- **Daily_Questï¼ˆæ—¥å¸¸ä»»åŠ¡ï¼‰**: ä»NPCä»»åŠ¡æŒ‰é’®æ¥å–çš„ä½éš¾åº¦æ¯æ—¥é‡ç½®ä»»åŠ¡
- **Quest_Detection_Systemï¼ˆä»»åŠ¡æ£€æµ‹ç³»ç»Ÿï¼‰**: è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡å®Œæˆæ¡ä»¶çš„å­ç³»ç»Ÿ
- **Quest_Panelï¼ˆä»»åŠ¡é¢æ¿ï¼‰**: æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨å’Œè¯¦æƒ…çš„UIé¢æ¿
- **NPC_Quest_Buttonï¼ˆNPCä»»åŠ¡æŒ‰é’®ï¼‰**: NPCè¯¦æƒ…é¢æ¿ä¸Šçš„ğŸ“œä»»åŠ¡æŒ‰é’®
- **Dawn_Resetï¼ˆé»æ˜é‡ç½®ï¼‰**: æ˜¼å¤œå¾ªç¯ä»å¤œæ™šè½¬ä¸ºç™½å¤©æ—¶è§¦å‘çš„é‡ç½®äº‹ä»¶
- **Quest_Dataï¼ˆä»»åŠ¡æ•°æ®ï¼‰**: å­˜å‚¨åœ¨JSONæ–‡ä»¶ä¸­çš„ä»»åŠ¡å®šä¹‰æ•°æ®
- **Progress_Trackerï¼ˆè¿›åº¦è¿½è¸ªå™¨ï¼‰**: è¿½è¸ªæ¯ä¸ªä»»åŠ¡ç›®æ ‡å½“å‰è¿›åº¦çš„ç»„ä»¶

## éœ€æ±‚

### éœ€æ±‚ 1ï¼šä»»åŠ¡æ•°æ®æ¨¡å‹ä¸å­˜å‚¨

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘å¸Œæœ›æœ‰ä¸€ä¸ªç»“æ„åŒ–çš„ä»»åŠ¡æ•°æ®æ¨¡å‹ï¼Œä»¥ä¾¿ç³»ç»Ÿèƒ½å¤Ÿç»Ÿä¸€ç®¡ç†ä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

#### éªŒæ”¶æ ‡å‡†

1. THE Quest_System SHALL define a quest data structure containing: id, name, description, type (main/side/daily), npcId, objectives (array), rewards, prerequisites, and status
2. THE Quest_System SHALL store quest definitions in a JSON data file (`quests.json`) separate from game logic
3. THE Quest_System SHALL load quest definitions asynchronously during game initialization
4. WHEN a quest has multiple objectives, THE Quest_System SHALL track progress for each objective independently
5. THE Quest_System SHALL support the following reward types: gold, crystal, and items (with itemId and quantity)

### éœ€æ±‚ 2ï¼šä¸»çº¿ä»»åŠ¡é“¾

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›æœ‰ä¸€ç³»åˆ—ä¸»çº¿ä»»åŠ¡å¼•å¯¼æˆ‘è®¤è¯†å„ä¸ªNPCå’Œæ¸¸æˆåŠŸèƒ½ï¼Œä»¥ä¾¿æˆ‘èƒ½é€æ­¥äº†è§£æ¸¸æˆç©æ³•ã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN the game starts, THE Quest_System SHALL make the first main quest available without any prerequisites
2. WHEN a main quest is completed, THE Quest_System SHALL automatically make the next main quest in the chain available
3. THE Quest_System SHALL provide 8-10 main quests covering the progression: village_chief â†’ bartender (tavern) â†’ recruit adventurer â†’ grassland exploration â†’ blacksmith_zz (crafting) â†’ alchemist_tuanzi (alchemy) â†’ chef_curry (cooking) â†’ trainer_alin (job change) â†’ summoner_kaoezi (summoning) â†’ scholar_xiaomei (card collection)
4. WHEN a main quest objective involves unlocking an NPC, THE Quest_System SHALL unlock that NPC from the lockedNPCs set upon quest completion
5. THE Quest_System SHALL auto-detect main quest completion without requiring manual turn-in by the player

### éœ€æ±‚ 3ï¼šæ”¯çº¿ä»»åŠ¡

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›èƒ½ä»å„ä¸ªNPCå¤„æ¥å–ä¸“å±æ”¯çº¿ä»»åŠ¡ï¼Œä»¥ä¾¿è·å¾—é¢å¤–å¥–åŠ±å’ŒæŒ‘æˆ˜ã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN a player clicks the quest button on an NPC detail panel, THE Quest_Panel SHALL display quests specific to that NPC
2. THE Quest_System SHALL provide NPC-specific side quests: blacksmith_zz provides crafting quests, chef_curry provides cooking quests, alchemist_tuanzi provides alchemy quests, and other NPCs provide quests matching their roles
3. WHEN a player accepts a side quest, THE Quest_System SHALL move the quest from available to inProgress status
4. WHEN a side quest is completed, THE Quest_System SHALL prevent the same quest from becoming available again
5. THE Quest_System SHALL offer medium-difficulty side quests with rewards including gold, potions, dishes, materials, equipment, and crystals

### éœ€æ±‚ 4ï¼šæ—¥å¸¸ä»»åŠ¡

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›æ¯å¤©æœ‰å¯é‡å¤çš„æ—¥å¸¸ä»»åŠ¡ï¼Œä»¥ä¾¿æˆ‘æœ‰æŒç»­çš„çŸ­æœŸç›®æ ‡å’Œç¨³å®šçš„æ”¶å…¥æ¥æºã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN a player clicks the quest button on an NPC detail panel, THE Quest_Panel SHALL display daily quests specific to that NPC alongside side quests
2. THE Quest_System SHALL provide NPC-specific daily quests with low difficulty and small rewards
3. WHEN dawn occurs (dayNightProgress cycles from night to day), THE Quest_System SHALL reset all completed daily quests to available status
4. WHEN a daily quest is reset, THE Quest_System SHALL clear the previous progress for that quest
5. THE Quest_System SHALL integrate daily quest reset into the existing onDawnEvents() method

### éœ€æ±‚ 5ï¼šä»»åŠ¡å®Œæˆè‡ªåŠ¨æ£€æµ‹

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›ä»»åŠ¡è¿›åº¦èƒ½è‡ªåŠ¨æ›´æ–°ï¼Œä»¥ä¾¿æˆ‘ä¸éœ€è¦æ‰‹åŠ¨æŠ¥å‘Šå®Œæˆæƒ…å†µã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN an item is added to the player inventory, THE Quest_Detection_System SHALL update progress for all active quests with item-possession objectives
2. WHEN the player switches to a new scene, THE Quest_Detection_System SHALL update progress for all active quests with scene-visit objectives
3. WHEN the player completes a crafting recipe (cooking, equipment, or alchemy), THE Quest_Detection_System SHALL update progress for all active quests with crafting-completion objectives
4. WHEN the player completes a battle in a combat stage, THE Quest_Detection_System SHALL update progress for all active quests with combat objectives
5. WHEN the player recruits an adventurer, THE Quest_Detection_System SHALL update progress for all active quests with recruitment objectives
6. WHEN the player gives a gift to an NPC, THE Quest_Detection_System SHALL update progress for all active quests with gift-giving objectives
7. WHEN an NPC's affinity changes, THE Quest_Detection_System SHALL update progress for all active quests with affinity-level objectives

### éœ€æ±‚ 6ï¼šNPCä»»åŠ¡æŒ‰é’®ä¸é¢æ¿é›†æˆ

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›æ‰€æœ‰NPCçš„ä»»åŠ¡æŒ‰é’®éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œä»¥ä¾¿æˆ‘èƒ½ä»ä»»ä½•NPCå¤„æŸ¥çœ‹å’Œæ¥å–ä»»åŠ¡ã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN a player clicks the quest button on any NPC, THE Quest_Panel SHALL open and display quests filtered by that NPC
2. THE Quest_Panel SHALL display three tabs: available quests (å¯æ¥ä»»åŠ¡), in-progress quests (è¿›è¡Œä¸­), and completed quests (å·²å®Œæˆ)
3. WHEN displaying NPC-specific quests, THE Quest_Panel SHALL show main quests (if relevant to that NPC), side quests, and daily quests for that NPC
4. WHEN a quest has completable objectives, THE Quest_Panel SHALL show a red dot indicator on the NPC's quest button and on the in-progress tab
5. IF no quests are available for an NPC, THEN THE Quest_Panel SHALL display an empty state message instead of the "coming soon" notification

### éœ€æ±‚ 7ï¼šä»»åŠ¡å¥–åŠ±å‘æ”¾

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›å®Œæˆä»»åŠ¡åèƒ½ç«‹å³è·å¾—å¥–åŠ±ï¼Œä»¥ä¾¿æˆ‘æœ‰æˆå°±æ„Ÿå’Œç»§ç»­æ¸¸æˆçš„åŠ¨åŠ›ã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN a quest is completed, THE Quest_System SHALL grant all specified gold rewards using the CurrencySystem
2. WHEN a quest is completed, THE Quest_System SHALL grant all specified crystal rewards using the CurrencySystem
3. WHEN a quest is completed, THE Quest_System SHALL grant all specified item rewards using the ItemSystem
4. WHEN rewards are granted, THE Quest_System SHALL display a notification listing all received rewards
5. WHEN a main quest completion unlocks an NPC, THE Quest_System SHALL remove that NPC from the lockedNPCs set and display an unlock notification

### éœ€æ±‚ 8ï¼šä»»åŠ¡æŒä¹…åŒ–

**ç”¨æˆ·æ•…äº‹ï¼š** ä½œä¸ºç©å®¶ï¼Œæˆ‘å¸Œæœ›ä»»åŠ¡è¿›åº¦åœ¨æ¸¸æˆä¿å­˜å’ŒåŠ è½½æ—¶èƒ½è¢«ä¿ç•™ï¼Œä»¥ä¾¿æˆ‘ä¸ä¼šä¸¢å¤±ä»»åŠ¡è¿›åº¦ã€‚

#### éªŒæ”¶æ ‡å‡†

1. WHEN the game state is saved, THE Quest_System SHALL serialize all quest states including status, progress, and completion history
2. WHEN the game state is loaded, THE Quest_System SHALL restore all quest states from the saved data
3. FOR ALL valid quest state objects, serializing then deserializing SHALL produce an equivalent quest state (round-trip property)
4. WHEN a saved game contains completed daily quests from a previous day, THE Quest_System SHALL reset those daily quests upon loading
