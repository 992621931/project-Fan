<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•å¼‚ç•Œè§’è‰² - ä»“åº“æ˜¾ç¤º</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .test-section {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .test-result {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid #4CAF50;
    }
    .error {
      background: rgba(244, 67, 54, 0.3);
      border: 1px solid #f44336;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background 0.2s;
    }
    button:hover {
      background: #2980b9;
    }
    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .character-card {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    .character-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .character-stats {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒŸ å¼‚ç•Œè§’è‰²æµ‹è¯• - ä»“åº“æ˜¾ç¤º</h1>
    
    <div class="test-section">
      <h2>è¯´æ˜</h2>
      <p>æ­¤æµ‹è¯•éªŒè¯å¼‚ç•Œè§’è‰²æ˜¯å¦æ­£ç¡®æ³¨å†Œåˆ° NPCSystem å¹¶æ˜¾ç¤ºåœ¨ä»“åº“ä¸­ã€‚</p>
      <p>æµ‹è¯•æ­¥éª¤ï¼š</p>
      <ol>
        <li>åˆå§‹åŒ–æ¸¸æˆç³»ç»Ÿ</li>
        <li>ä» ConfigManager è·å–å¼‚ç•Œè§’è‰²é…ç½®</li>
        <li>åˆ›å»ºå¼‚ç•Œè§’è‰²ï¼ˆæ¨¡æ‹Ÿå¼€å‘è€…åŠŸèƒ½ï¼‰</li>
        <li>éªŒè¯è§’è‰²æ˜¯å¦åœ¨ NPCSystem çš„å·²æ‹›å‹Ÿè§’è‰²åˆ—è¡¨ä¸­</li>
        <li>æ˜¾ç¤ºè§’è‰²è¯¦ç»†ä¿¡æ¯</li>
      </ol>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯• 1: åˆå§‹åŒ–ç³»ç»Ÿ</h2>
      <button onclick="testInitialization()">è¿è¡Œæµ‹è¯•</button>
      <div id="init-result"></div>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯• 2: è·å–å¼‚ç•Œè§’è‰²é…ç½®</h2>
      <button onclick="testGetOtherworldCharacters()">è¿è¡Œæµ‹è¯•</button>
      <div id="config-result"></div>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯• 3: åˆ›å»ºå¼‚ç•Œè§’è‰²</h2>
      <button onclick="testCreateOtherworldCharacter()">è¿è¡Œæµ‹è¯•</button>
      <div id="create-result"></div>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯• 4: éªŒè¯è§’è‰²åœ¨ä»“åº“ä¸­</h2>
      <button onclick="testCharacterInWarehouse()">è¿è¡Œæµ‹è¯•</button>
      <div id="warehouse-result"></div>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯• 5: æ˜¾ç¤ºæ‰€æœ‰å·²æ‹›å‹Ÿè§’è‰²</h2>
      <button onclick="testShowAllRecruitedCharacters()">è¿è¡Œæµ‹è¯•</button>
      <div id="all-characters-result"></div>
    </div>
  </div>

  <script type="module">
    import { DataLoader } from './dist/game/data/DataLoader.js';
    import { ConfigManager } from './dist/game/config/ConfigManager.js';
    import { World } from './dist/ecs/World.js';
    import { EventSystem } from './dist/ecs/EventSystem.js';
    import { NPCSystem } from './dist/game/systems/NPCSystem.js';

    window.dataLoader = null;
    window.configManager = null;
    window.world = null;
    window.eventSystem = null;
    window.npcSystem = null;
    window.otherworldCharacters = null;
    window.createdCharacterId = null;

    window.testInitialization = async function() {
      const resultDiv = document.getElementById('init-result');
      resultDiv.innerHTML = '<p>æ­£åœ¨åˆå§‹åŒ–...</p>';
      
      try {
        // Initialize DataLoader
        window.dataLoader = DataLoader.getInstance();
        await window.dataLoader.loadGameData();
        
        // Get ConfigManager
        window.configManager = ConfigManager.getInstance();
        
        // Initialize World and NPCSystem
        window.eventSystem = new EventSystem();
        window.world = new World(window.eventSystem);
        window.npcSystem = new NPCSystem(window.world);
        
        resultDiv.innerHTML = `
          <div class="test-result success">
            <p>âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ</p>
            <p>DataLoader: ${window.dataLoader.isLoaded() ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}</p>
            <p>ConfigManager: ${window.configManager.isInitialized() ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</p>
            <p>NPCSystem: å·²åˆ›å»º</p>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-result error">
            <p>âŒ é”™è¯¯: ${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    };

    window.testGetOtherworldCharacters = async function() {
      const resultDiv = document.getElementById('config-result');
      resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
      
      try {
        if (!window.configManager || !window.configManager.isInitialized()) {
          await window.testInitialization();
        }
        
        window.otherworldCharacters = window.configManager.getOtherworldCharacters();
        const otherworldTypeCharacters = window.otherworldCharacters.filter(char => 
          char.characterTypes && char.characterTypes.includes('å¼‚ç•Œ')
        );
        
        resultDiv.innerHTML = `
          <div class="test-result success">
            <p>âœ… æˆåŠŸè·å–å¼‚ç•Œè§’è‰²é…ç½®</p>
            <p>æ€»å¼‚ç•Œè§’è‰²æ•°é‡: ${window.otherworldCharacters.length}</p>
            <p>åŒ…å«"å¼‚ç•Œ"ç±»å‹çš„è§’è‰²æ•°é‡: ${otherworldTypeCharacters.length}</p>
            <pre>${JSON.stringify(otherworldTypeCharacters, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-result error">
            <p>âŒ é”™è¯¯: ${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    };

    window.testCreateOtherworldCharacter = async function() {
      const resultDiv = document.getElementById('create-result');
      resultDiv.innerHTML = '<p>æ­£åœ¨åˆ›å»ºè§’è‰²...</p>';
      
      try {
        if (!window.otherworldCharacters || window.otherworldCharacters.length === 0) {
          await window.testGetOtherworldCharacters();
        }
        
        // Get first otherworld character with "å¼‚ç•Œ" type
        const charConfig = window.otherworldCharacters.find(char => 
          char.characterTypes && char.characterTypes.includes('å¼‚ç•Œ')
        );
        
        if (!charConfig) {
          throw new Error('æ²¡æœ‰æ‰¾åˆ°åŒ…å«"å¼‚ç•Œ"ç±»å‹çš„è§’è‰²');
        }
        
        // Create character (simulate the createOtherworldCharacter method)
        const characterId = `otherworld_${charConfig.id}_${Date.now()}`;
        window.createdCharacterId = characterId;
        
        // Calculate secondary attributes
        const baseAttack = Math.floor(charConfig.baseAttributes.strength * 2 + charConfig.baseAttributes.technique * 0.5);
        const baseDefense = Math.floor(charConfig.baseAttributes.strength * 0.5 + charConfig.baseAttributes.agility * 0.3);
        const baseMoveSpeed = Math.floor(100 + charConfig.baseAttributes.agility * 2);
        
        const npcData = {
          id: characterId,
          name: charConfig.name,
          title: charConfig.title,
          emoji: 'ğŸŒŸ',
          type: 'Adventurer',
          level: charConfig.initialState.level,
          maxLevel: 20,
          currentEXP: 0,
          maxEXP: 100,
          currentHP: charConfig.initialState.maxHealth,
          maxHP: charConfig.initialState.maxHealth,
          currentMP: charConfig.initialState.maxMana,
          maxMP: charConfig.initialState.maxMana,
          currentHunger: charConfig.initialState.maxHunger,
          maxHunger: charConfig.initialState.maxHunger,
          job: charConfig.startingJob,
          skills: charConfig.initialSkills?.active || [],
          equipment: [],
          equippedItems: { weapon: null, armor: null, offhand: null, accessory: null },
          passiveSkill: charConfig.initialSkills?.passive?.[0],
          activeSkill: charConfig.initialSkills?.active?.[0],
          learnedActiveSkills: charConfig.initialSkills?.active || [],
          size: 1,
          strength: charConfig.baseAttributes.strength,
          agility: charConfig.baseAttributes.agility,
          wisdom: charConfig.baseAttributes.wisdom,
          skill: charConfig.baseAttributes.technique,
          attack: baseAttack,
          defense: baseDefense,
          moveSpeed: baseMoveSpeed,
          dodgeRate: Math.floor(charConfig.baseAttributes.agility * 0.5),
          critRate: Math.floor(charConfig.baseAttributes.technique * 0.8),
          critDamage: 150 + Math.floor(charConfig.baseAttributes.technique * 2),
          resistance: Math.floor(charConfig.baseAttributes.wisdom * 0.5),
          magicPower: Math.floor(charConfig.baseAttributes.wisdom * 2),
          carryWeight: Math.floor(50 + charConfig.baseAttributes.strength * 5),
          accuracy: Math.floor(80 + charConfig.baseAttributes.technique * 0.5),
          expRate: 100,
          hpRegen: Math.floor(1 + charConfig.baseAttributes.strength * 0.1),
          mpRegen: Math.floor(1 + charConfig.baseAttributes.wisdom * 0.1),
          weight: 70,
          volume: 1,
          affinity: 0
        };
        
        // Register with NPCSystem
        window.npcSystem.recruitCharacter(npcData);
        
        resultDiv.innerHTML = `
          <div class="test-result success">
            <p>âœ… æˆåŠŸåˆ›å»ºå¼‚ç•Œè§’è‰²</p>
            <div class="character-card">
              <div class="character-name">ğŸŒŸ ${npcData.name} - ${npcData.title}</div>
              <div class="character-stats">
                <p>ID: ${npcData.id}</p>
                <p>èŒä¸š: ${npcData.job} | ç­‰çº§: ${npcData.level}</p>
                <p>ç”Ÿå‘½: ${npcData.currentHP}/${npcData.maxHP} | é­”æ³•: ${npcData.currentMP}/${npcData.maxMP}</p>
                <p>åŠ›é‡: ${npcData.strength} | æ•æ·: ${npcData.agility} | æ™ºæ…§: ${npcData.wisdom} | æŠ€å·§: ${npcData.skill}</p>
                <p>æ”»å‡»: ${npcData.attack} | é˜²å¾¡: ${npcData.defense} | ç§»é€Ÿ: ${npcData.moveSpeed}</p>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-result error">
            <p>âŒ é”™è¯¯: ${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    };

    window.testCharacterInWarehouse = async function() {
      const resultDiv = document.getElementById('warehouse-result');
      resultDiv.innerHTML = '<p>æ­£åœ¨éªŒè¯...</p>';
      
      try {
        if (!window.createdCharacterId) {
          await window.testCreateOtherworldCharacter();
        }
        
        // Get recruited characters from NPCSystem
        const recruitedCharacters = window.npcSystem.getRecruitedCharacters();
        const character = recruitedCharacters.find(char => char.id === window.createdCharacterId);
        
        if (character) {
          resultDiv.innerHTML = `
            <div class="test-result success">
              <p>âœ… è§’è‰²å·²æˆåŠŸæ³¨å†Œåˆ°ä»“åº“</p>
              <div class="character-card">
                <div class="character-name">ğŸŒŸ ${character.name} - ${character.title}</div>
                <div class="character-stats">
                  <p>åœ¨ä»“åº“ä¸­æ‰¾åˆ°è§’è‰²ï¼</p>
                  <p>ID: ${character.id}</p>
                  <p>ç±»å‹: ${character.type}</p>
                </div>
              </div>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="test-result error">
              <p>âŒ è§’è‰²æœªåœ¨ä»“åº“ä¸­æ‰¾åˆ°</p>
              <p>åˆ›å»ºçš„è§’è‰²ID: ${window.createdCharacterId}</p>
              <p>ä»“åº“ä¸­çš„è§’è‰²æ•°é‡: ${recruitedCharacters.length}</p>
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-result error">
            <p>âŒ é”™è¯¯: ${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    };

    window.testShowAllRecruitedCharacters = async function() {
      const resultDiv = document.getElementById('all-characters-result');
      resultDiv.innerHTML = '<p>æ­£åœ¨è·å–æ‰€æœ‰è§’è‰²...</p>';
      
      try {
        if (!window.npcSystem) {
          await window.testInitialization();
        }
        
        const recruitedCharacters = window.npcSystem.getRecruitedCharacters();
        
        let html = `
          <div class="test-result success">
            <p>âœ… å·²æ‹›å‹Ÿè§’è‰²æ€»æ•°: ${recruitedCharacters.length}</p>
        `;
        
        recruitedCharacters.forEach(char => {
          html += `
            <div class="character-card">
              <div class="character-name">${char.emoji} ${char.name} - ${char.title || 'æ— ç§°å·'}</div>
              <div class="character-stats">
                <p>ID: ${char.id}</p>
                <p>ç±»å‹: ${char.type} | èŒä¸š: ${char.job} | ç­‰çº§: ${char.level}</p>
                <p>ç”Ÿå‘½: ${char.currentHP}/${char.maxHP} | é­”æ³•: ${char.currentMP}/${char.maxMP}</p>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-result error">
            <p>âŒ é”™è¯¯: ${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    };
  </script>
</body>
</html>
